<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Addams Family | Quiz</title>
    <link rel="stylesheet" href="./css/dashboards.css" />
    <link rel="icon" href="./assets/icon/logosiyte.png" />
    <script src="./js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="obterDados()">
    <div class="janela">
        <div class="header-left">
            <div class="logo">
                <img src="./assets/icon/addams-family-seeklogo.png" class="logo" width="210px" height="90px" />
            </div>

            <div class="hello">
                <h1>Olá, <span id="b_usuario">Addams</span>!</h1>
            </div>

            <div class="btn-nav btn-selected">
                <a href="./dashboard.html">
                    <h3>Dashboard </h3>
                </a>
            </div>
            <div class="btn-nav">
                <a href="./quiz.html">
                    <h3>Quiz</h3>
                </a>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>
        </div>

        <div class="dash-content">
            <h2 class="titulo">Dashboard  |  Quiz Família Addams</h2>
            <div class="cards">
                <div class="card1">
                    <h3>Jogadores Registrados:<br /></h3><br>
                    
                    <h3 id="totalJogadores">0</h3>
                </div>
                <div class="card2">
                    <h3>Tentativas Realizadas:<br /></h3>
                    <br /> 
                    <h3 id="totalTentativas"></h3>
                    <br /><br /><br /><br />
                </div>
                <div class="card3">
                    <h3>Resultado Personagem:<br/></h3><br>
                    <h3 id="personagemTop">-</h3>
                </div>
                <div class="card4">
                    <h3>Características Comuns:<br /></h3><br>
                    <h3 id="caracTop">-</h3>
                </div>
            </div>
            <div class="graficos-grid">
                <div class="box-grafico1">
                    <h2>Popularidade das Caracteristicas:</h2>
                    <br /><br />
                    <canvas id="barraCaracteristicas"></canvas>
                </div>
                <div class="box-grafico2">
                    <h2>Porcentagem dos seus Resultados:</h2>
                    <canvas id="pizzaPersonagens"></canvas>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    document.getElementById('b_usuario').innerText = sessionStorage.NOME_USUARIO || "Addams";

    let graficoLinha = null;
    let graficoBarra = null;

    function obterDados() {
        atualizarDashboard();
    }

    function atualizarDashboard() {
        obterTotalUsuarios();
        obterDadosUsuario();
    }

    function obterTotalUsuarios() {
        fetch("/usuarios/listarTodos")
            .then(r => r.json())
            .then(data => {
                document.getElementById("totalJogadores").innerText = data.totalUsuarios;
            })
            .catch(err => console.error("Erro ao carregar jogadores:", err));
    }

    function obterDadosUsuario() {
        const idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/dashboard/dadosUsuario/${idUsuario}`)
            .then(r => r.json())
            .then(data => {
                console.log("DADOS DO USUÁRIO:", data);

                document.getElementById("totalTentativas").innerText = data.tentativas;

                if (data.personagens.length > 0) {
                    let topPerso = data.personagens[0];
                    document.getElementById("personagemTop").innerText =
                        `${topPerso.nome} `;
                } else {
                    document.getElementById("personagemTop").innerText = "-";
                }

                if (data.caracteristicas.length > 0) {
                    let topCarac = data.caracteristicas[0];
                    document.getElementById("caracTop").innerText =
                        `${topCarac.nomeCaracteristica}`;
                } else {
                    document.getElementById("caracTop").innerText = "-";
                }

                const countCaracteristica = {};
                data.caracteristicas.forEach(item => {
                    countCaracteristica[item.nomeCaracteristica] = item.votos;
                });

                const countPersonagem = {};
                data.personagens.forEach(item => {
                    countPersonagem[item.nome] = item.votos;
                });

                plotarGraficoLinha(countCaracteristica);
                plotarGraficoBarra(countPersonagem);
            })
            .catch(err => console.error("Erro ao carregar dados do usuário:", err));
    }

    function plotarGraficoLinha(countCaracteristica) {
        const labels = Object.keys(countCaracteristica);
        const valores = Object.values(countCaracteristica);
        const ctx = document.getElementById('barraCaracteristicas').getContext('2d');

        if (graficoLinha) {
            graficoLinha.destroy();
        }

        graficoLinha = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Popularidade das Características',
                    data: valores,
                    backgroundColor: [
                        'rgb(15, 15, 15)',
                        'rgb(70, 0, 90)',
                        'rgb(15, 20, 92)',
                        'rgb(102, 7, 140)',
                        'rgb(56, 135, 63)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    function plotarGraficoBarra(countPersonagem) {
        const labels = Object.keys(countPersonagem);
        const valores = Object.values(countPersonagem);

        const ctx = document.getElementById('pizzaPersonagens').getContext('2d');

        if (graficoBarra) {
            graficoBarra.destroy();
        }

        graficoBarra = new Chart(ctx, {
            type: 'pie',
            data: {
                labels,
                datasets: [{
                    data: valores,
                    backgroundColor: [
                        'rgb(15, 15, 15)',
                        'rgb(70, 0, 90)',
                        'rgb(15, 20, 92)',
                        'rgb(102, 7, 140)',
                        'rgb(56, 135, 63)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true }
                }
            }
        });
    }
</script>

    